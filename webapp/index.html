<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AnkleCapture">
    <title>AnkleCapture - 足関節角度測定</title>

    <!-- Styles -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/camera.css">
    <link rel="stylesheet" href="css/measurement.css">
</head>

<body>
    <!-- Screen 1: Subject Information -->
    <div id="screen-subject" class="screen active">
        <header class="app-header">
            <h1>📱 AnkleCapture</h1>
            <p class="subtitle">足関節角度測定システム</p>
        </header>

        <main class="content">
            <form id="subject-form" class="form-card">
                <h2>被験者情報</h2>

                <div class="form-group">
                    <label for="subject-id">被験者ID *</label>
                    <input type="text" id="subject-id" name="subject-id" required placeholder="例: P001"
                        autocomplete="off">
                </div>

                <div class="form-group">
                    <label for="operator-id">測定者ID</label>
                    <input type="text" id="operator-id" name="operator-id" placeholder="例: OT_yamada"
                        autocomplete="off">
                </div>

                <div class="form-group">
                    <label>測定側 *</label>
                    <div class="radio-group">
                        <label class="radio-label">
                            <input type="radio" name="side" value="L" checked>
                            <span>左足 (L)</span>
                        </label>
                        <label class="radio-label">
                            <input type="radio" name="side" value="R">
                            <span>右足 (R)</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="measurement-type">測定種別 *</label>
                    <select id="measurement-type" name="measurement-type" required>
                        <option value="ankle_dorsiflexion">足関節背屈角度</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>測定モード *</label>
                    <div class="mode-selector">
                        <label class="mode-option">
                            <input type="radio" name="mode" value="realtime" checked>
                            <div class="mode-card">
                                <span class="mode-icon">📱</span>
                                <span class="mode-label">実時間撮影</span>
                                <span class="mode-desc">カメラで撮影</span>
                            </div>
                        </label>
                        <label class="mode-option">
                            <input type="radio" name="mode" value="import">
                            <div class="mode-card">
                                <span class="mode-icon">🖼️</span>
                                <span class="mode-label">写真導入</span>
                                <span class="mode-desc">既存の写真を使用</span>
                            </div>
                        </label>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-large">
                    📷 測定を開始
                </button>
            </form>
        </main>
    </div>

    <!-- Screen 2: Camera Preview -->
    <div id="screen-camera" class="screen">
        <header class="camera-header">
            <button id="btn-back-to-subject" class="btn btn-icon" aria-label="戻る">
                ← 戻る
            </button>
            <div class="header-title">
                <span id="current-side-display">左足</span>
            </div>
            <button id="btn-toggle-side" class="btn btn-secondary">
                左右切替
            </button>
        </header>

        <!-- Camera Preview Container -->
        <div id="camera-container" class="camera-container">
            <!-- Video Stream (z-index: 0) -->
            <video id="camera-preview" playsinline muted autoplay></video>

            <!-- Import Preview Canvas (hidden by default, z-index: 0) -->
            <canvas id="import-preview-canvas" class="hidden"></canvas>

            <!-- Canvas for Grid and Lines (z-index: 10) -->
            <canvas id="overlay-canvas"></canvas>

            <!-- SVG for Foot Outline (z-index: 20) -->
            <div id="foot-guide-container" class="foot-guide-container">
                <img id="foot-guide" src="assets/foot-left.svg" alt="足部ガイド">
            </div>

            <!-- Level Indicator (z-index: 35) -->
            <div id="level-indicator-container" class="level-indicator-container">
                <div id="level-indicator" class="level-indicator">
                    <div class="level-bar">
                        <div class="level-marker" id="roll-marker"></div>
                    </div>
                    <div class="level-values" id="level-values">
                        <span class="level-value-item">Pitch: <span id="pitch-value">--</span>°</span>
                        <span class="level-value-item">Roll: <span id="roll-value">--</span>°</span>
                    </div>
                    <div class="level-text" id="level-text">水平仪を有効化</div>
                    <button id="btn-enable-orientation" class="btn btn-small">
                        有効化
                    </button>
                </div>
            </div>

            <!-- Step Guidance (z-index: 40) -->
            <div id="step-guidance" class="step-guidance">
                <div class="step-header">
                    <div class="step-progress">
                        <div class="step-dot" data-step="1"><span>1</span></div>
                        <div class="step-dot" data-step="2"><span>2</span></div>
                        <div class="step-dot" data-step="3"><span>3</span></div>
                        <div class="step-dot" data-step="4"><span>4</span></div>
                    </div>
                    <span id="step-counter">ステップ 1/4</span>
                </div>
                <div class="step-content">
                    <p id="step-instruction" class="step-instruction">
                        足をガイド枠内に配置してください
                    </p>
                    <button id="btn-step-confirm" class="btn btn-success">
                        ✓ 確認
                    </button>
                </div>
            </div>
        </div>

        <!-- Capture Button -->
        <div class="camera-controls">
            <div id="distance-warning" class="distance-warning hidden">
                ⚠️ 距離が適切ではありません
            </div>
            <button id="btn-capture" class="btn btn-capture" disabled>
                📸 撮影
            </button>
        </div>
    </div>

    <!-- Screen 3: Measurement -->
    <div id="screen-measurement" class="screen">
        <header class="app-header">
            <button id="btn-back-to-camera" class="btn btn-icon">
                ← 再撮影
            </button>
            <h2>角度測定</h2>
        </header>

        <main class="content">
            <div class="measurement-container">
                <div class="instruction-card">
                    <p>📍 3点をタップして角度を測定してください</p>
                    <ol id="point-labels">
                        <li>腓骨頭</li>
                        <li>外果</li>
                        <li>第5中足骨頭</li>
                    </ol>
                    <div id="angle-result" class="angle-result hidden">
                        <strong>測定角度:</strong> <span id="angle-value">--</span>°
                    </div>
                </div>

                <div class="image-container">
                    <canvas id="measurement-canvas"></canvas>
                </div>

                <div class="measurement-controls">
                    <button id="btn-reset-points" class="btn btn-secondary">
                        🔄 リセット
                    </button>
                    <button id="btn-save-measurement" class="btn btn-primary" disabled>
                        💾 保存
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Screen 4: Export/Results -->
    <div id="screen-export" class="screen">
        <header class="app-header">
            <h2>データエクスポート</h2>
        </header>

        <main class="content">
            <div class="export-container">
                <div class="result-summary">
                    <h3>測定完了</h3>
                    <div class="summary-grid">
                        <div class="summary-item">
                            <span class="label">被験者ID:</span>
                            <span id="export-subject-id">--</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">測定側:</span>
                            <span id="export-side">--</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">角度:</span>
                            <span id="export-angle">--</span>°
                        </div>
                        <div class="summary-item">
                            <span class="label">測定日時:</span>
                            <span id="export-timestamp">--</span>
                        </div>
                    </div>
                </div>

                <div class="export-options">
                    <h3>エクスポート形式</h3>
                    <button id="btn-export-csv" class="btn btn-primary btn-large">
                        📊 CSV形式でダウンロード
                    </button>
                    <button id="btn-export-json" class="btn btn-secondary btn-large">
                        📄 JSON形式でダウンロード
                    </button>
                    <button id="btn-export-images" class="btn btn-secondary btn-large">
                        🖼️ 画像をダウンロード
                    </button>
                </div>

                <div class="export-actions">
                    <button id="btn-new-measurement" class="btn btn-success btn-large">
                        ➕ 新規測定
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Hidden File Input for Import Mode -->
    <input type="file" id="photo-input" accept="image/*" class="hidden">

    <!-- Distance Confirmation Modal -->
    <div id="distance-modal" class="modal hidden">
        <div class="modal-content">
            <h3>🔶 距離確認</h3>
            <p>カメラと被験者の距離は約 <strong>3m</strong> ですか?</p>

            <div class="distance-guide">
                <p><strong>💡 参考ガイド:</strong></p>
                <ul>
                    <li>一般的な床タイル（80cm）≈ 約4枚分</li>
                    <li>畳 1畳の長辺 ≈ 約180cm ≈ 約1.7畳分</li>
                    <li>腕を広げた幅 ≈ 約170cm ≈ 約1.8倍</li>
                </ul>
            </div>

            <div class="modal-buttons">
                <button class="btn btn-warning distance-option" data-distance="too_close">
                    近すぎる
                </button>
                <button class="btn btn-success distance-option" data-distance="appropriate">
                    ✓ 適切
                </button>
                <button class="btn btn-warning distance-option" data-distance="too_far">
                    遠すぎる
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/storage.js"></script>
    <script src="js/camera.js"></script>
    <script src="js/orientation.js"></script>
    <script src="js/overlay.js"></script>
    <script src="js/capture.js"></script>
    <script src="js/measurement.js"></script>
    <script src="js/export.js"></script>
    <script src="js/import.js"></script>
    <script src="js/app.js"></script>
</body>

</html>